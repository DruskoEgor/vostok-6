import numpy as np
import matplotlib.pyplot as plt
from scipy.integrate import solve_ivp
import math


# параметры ракеты (без округлений)
t1, t2 = 101, 210  # времена отделения первой ступени и конец

m = 414_509.812             # начальная масса ракеты

fuel_stage1 = 174_440   # масса топлива первой ступени
fuel_stage2 = 17_480     # масса топлива второй ступени
dry_stage = 97_280     # масса сухой ступени

Ft1, Ft2 = 6_000_000, 1_500_000  # тяга первой и второй ступеней
k1, k2 = 1_953, 484              # расход топлива в секунду для ступеней

# константы
ro = 1.225       # плотность воздуха на уровне моря
g = 9.80665      # ускорение свободного падения
Cd = 0.3         # коэффициент аэродинамического сопротивления
S = 80           # площадь поперечного сечения ракеты


# данные симуляции (без округлений)
t_ksp = np.array([0.0,1.3,2.6,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.0,12.0,13.0,14.0,15.0,16.0,17.0,18.0,19.0,
                  20.0,21.0,22.0,23.0,24.0,25.0,26.0,27.0,28.0,29.0,30.0,31.0,32.0,33.0,34.0,35.0,36.0,37.0,38.0,39.0,
                  40.0,41.0,42.0,43.0,44.0,45.0,46.0,47.0,48.0,49.0,50.0,51.0,52.0,53.0,54.0,55.0,56.0,57.0,58.0,59.0,
                  60.0,61.0,62.0,63.0,64.0,65.0,66.0,67.0,68.0,69.0,70.0,71.0,72.0,73.0,74.0,75.0,76.0,77.0,78.0,79.0,
                  80.0,81.0,82.0,83.0,84.0,85.0,86.0,87.0,88.0,89.0,90.0,91.0,92.0,93.0,94.0,95.0,96.0,97.0,98.0,99.0,
                  100.0,101.0,102.0,103.4,104.0,105.0,106.0,107.0,108.0,109.0,110.0,111.0,112.0,113.0,114.0,115.0,116.0,117.0,118.0,119.0,
                  120.0,121.0,122.0,123.0,124.0,125.0,126.0,127.0,128.0,129.0,130.0,131.0,132.0,133.0,134.0,135.0,136.0,137.0,138.0,139.0,
                  140.0,141.0,142.0,143.0,144.0,145.0,146.0,147.0,148.0,149.0,150.0,151.0,152.0,153.0,154.0,155.0,156.0,157.0,158.0,159.0,
                  160.0,161.0,162.0,163.0,164.0,165.0,166.0,167.0,168.0,169.0,170.0,171.0,172.0,173.0,174.0,175.0,176.0,177.0,178.0,179.0,
                  180.0,181.0,182.0,183.0,184.0,185.0,186.0,187.0,188.0,189.0,190.0,191.0,192.0,193.0,194.0,195.0,196.0,197.0,198.0,199.0,
                  200.0,201.0,202.0,203.0,204.0,205.0,206.0,207.0,208.0,209.0,210.0])
h_ksp = np.array([85.1,85.1,87.5,93.6,103.4,116.9,134.6,155.9,181.1,210.4,243.8,281.3,323.1,369.3,419.8,473.6,533.1,597.2,666.0,738.2,
                  818.2,901.7,988.4,1083.9,1182.8,1287.1,1396.7,1509.5,1632.6,1759.1,1888.6,2026.7,2173.6,2323.9,2477.1,2639.7,2808.7,2984.3,3170.2,3359.2,
                  3555.1,3757.9,3967.8,4185.0,4409.4,4641.3,4880.8,5128.0,5383.0,5645.7,5916.3,6194.7,6481.2,6769.9,7079.0,7384.3,7704.3,8039.7,8377.7,8725.0,
                  9074.4,9440.5,9816.3,10202.1,10598.1,11004.5,11421.3,11848.8,12287.5,12737.4,13198.8,13671.8,14156.5,14663.4,15172.8,15694.6,16229.1,16776.5,17337.0,17910.9,
                  18498.2,19099.3,19714.5,20331.1,20987.5,21645.8,22318.9,23007.1,23710.7,24429.6,25149.5,25915.1,26682.1,27449.7,28265.6,29066.1,29900.0,30751.4,31620.5,32507.3,
                  33411.8,34333.4,35293.0,36208.1,37136.8,38084.6,38995.9,39926.2,40875.4,41806.2,42737.1,43667.7,44598.1,45528.0,46438.7,47386.2,48314.6,49224.2,50170.6,51079.6,
                  52007.0,52952.8,53880.0,54807.2,55715.9,56643.3,57589.5,58498.8,59445.5,60355.4,61303.0,62213.8,63162.5,64093.2,65005.9,65956.7,66871.0,67804.9,68739.7,69675.6,
                  70612.7,71550.9,72508.8,73448.2,74387.9,75327.3,76266.3,77204.5,78141.6,79077.1,80010.9,80942.4,81871.2,82797.1,83719.6,84638.2,85552.6,86462.3,87366.8,88265.8,
                  89158.7,90045.1,90924.5,91796.5,92660.5,93499.1,94345.9,95183.5,96011.5,96829.9,97638.7,98438.1,99243.6,100008.3,100794.5,101555.8,102292.8,103050.3,103783.6,104507.5,
                  105222.2,105927.7,106624.0,107311.1,107989.1,108658.0,109317.8,109968.6,110610.4,111243.3,111867.2,112482.3,113088.5,113685.9,114274.6,114842.9,115425.6,115988.2,116531.1,117087.4,
                  117613.5,118141.9,118661.9,119173.4,119676.5,120171.3,120657.8,121136.0,121606.0,122067.8,122521.5])
v_ksp = np.array([0.0,0.0,4.2,7.9,11.6,15.4,19.3,23.2,27.2,31.3,35.4,39.6,43.9,48.3,52.7,57.1,61.7,66.4,71.2,75.9,
                  80.9,85.9,90.9,96.2,101.5,106.9,112.3,117.8,123.5,129.3,135.0,140.9,147.1,153.3,159.4,165.7,172.2,178.8,185.6,192.4,
                  199.3,206.3,213.5,220.7,228.1,235.6,243.3,251.0,258.8,266.6,274.4,282.3,290.5,298.6,307.3,315.6,324.3,333.5,342.6,352.0,
                  361.4,371.1,381.0,391.1,401.5,412.0,422.6,433.6,444.9,456.3,467.9,479.6,491.7,504.2,516.6,529.2,542.1,555.3,568.5,582.0,
                  595.8,609.7,623.9,638.0,652.8,667.6,682.7,697.9,713.4,729.1,744.7,761.2,777.7,794.0,811.2,828.0,845.4,863.1,881.0,899.0,
                  917.0,934.8,943.8,935.3,935.0,936.1,937.2,938.3,939.3,940.2,941.0,941.7,942.3,942.9,943.6,944.4,945.3,946.3,947.4,948.6,
                  950.0,951.5,953.0,954.7,956.5,958.4,960.5,962.6,964.9,967.2,969.7,972.3,975.0,977.8,980.7,983.8,986.9,990.2,993.6,997.1,
                  1000.8,1004.4,1007.9,1011.3,1014.5,1017.7,1020.7,1023.6,1026.4,1029.1,1031.6,1034.0,1036.2,1038.3,1040.2,1041.9,1043.5,1044.9,1046.1,1047.1,
                  1047.9,1048.5,1049.0,1049.2,1049.2,1049.1,1048.6,1048.2,1047.9,1047.8,1048.1,1048.6,1049.4,1050.5,1051.9,1053.6,1055.5,1057.8,1060.3,1063.2,
                  1066.3,1069.7,1073.4,1077.4,1081.7,1086.3,1091.2,1096.4,1101.8,1107.6,1113.6,1119.9,1126.5,1133.3,1140.5,1147.7,1155.6,1163.5,1171.6,1180.2,
                  1188.8,1197.8,1207.0,1216.6,1226.3,1236.3,1246.6,1257.1,1267.9,1278.9,1290.1])
m_ksp = np.array([414509.812,413404.594,412615.125,410641.469,408667.844,406694.156,404681.062,402707.406,400733.781,398760.125,396786.5,394812.844,392839.188,390865.562,388891.906,386957.75,384984.094,383010.438,381036.812,379102.625,
                  377089.5,375115.875,373181.688,371168.594,369194.938,367221.312,365247.656,363274.0,361300.375,359326.719,357392.562,355418.906,353405.781,351432.125,349497.969,347524.344,345550.656,343577.031,341563.906,339590.281,
                  337616.625,335642.969,333669.344,331695.688,329722.062,327748.406,325774.75,323801.125,321827.469,319853.844,317880.188,315906.531,313932.906,311998.719,309985.594,308051.438,306077.781,304064.688,302091.031,300117.375,
                  298183.219,296209.594,294235.906,292262.281,290288.656,288315.0,286341.344,284367.719,282394.062,280420.406,278446.781,276473.125,274499.5,272486.375,270512.719,268539.062,266565.438,264591.781,262618.156,260644.5,
                  258670.859,256697.219,254723.562,252789.391,250776.281,248802.641,246829.0,244855.359,242881.703,240908.062,238973.891,236960.766,234987.125,233052.953,231039.844,229066.203,227132.031,225158.391,223184.734,221211.094,
                  219237.453,217263.797,142789.812,142789.812,142365.469,141862.203,141378.656,140885.25,140381.969,139888.547,139395.141,138901.734,138408.312,137914.906,137431.359,136928.078,136434.672,135951.141,135447.859,134964.312,134470.891,133967.625,
                  133474.203,132980.797,132497.25,132003.844,131500.578,131017.023,130513.742,130030.203,129526.922,129043.367,128540.102,128046.68,127563.141,127059.867,126576.312,126082.906,125589.5,125096.094,124602.672,124109.266,
                  123605.984,123112.57,122619.164,122125.75,121632.344,121138.93,120645.523,120152.117,119658.703,119165.297,118671.883,118178.461,117685.062,117191.648,116698.234,116204.82,115711.406,115218.0,114724.586,114231.18,
                  113737.766,113244.359,112750.953,112267.406,111773.984,111280.586,110787.172,110293.758,109800.344,109306.938,108803.664,108320.117,107816.828,107323.422,106839.883,106336.602,105843.188,105349.781,104856.367,104362.953,
                  103869.539,103376.125,102882.727,102389.312,101895.906,101402.484,100909.078,100415.664,99922.258,99428.844,98935.438,98442.023,97948.609,97465.07,96961.789,96468.383,95984.836,95481.555,94998.016,94504.602,
                  94011.188,93517.781,93024.367,92530.961,92037.547,91544.141,91050.727,90557.312,90063.906])


def atmospheric_density(h):
    # плотность воздуха как функция высоты, экспоненциальное уменьшение
    return ro * math.exp(-h / 6000)

def mass(t):
    if t < t1:
        # 1-я ступень
        return m - k1 * t
    else:
        # 2-я ступень (1-я уже сброшена)
        return (m - fuel_stage1 - dry_stage) - k2 * (t - t1)


def thrust(t):
    # сила тяги ракеты в зависимости от ступени
    if t < t1:
        return Ft1
    elif t < t2:
        return Ft2
    else:
        return 0

# угол из автопилота
def angle(h):
    if h < 5000:
        return math.radians(90)
    elif h < 30000:
        return math.radians(85)
    elif h < 70000:
        return math.radians(45)
    else:
        return math.radians(25)

def equations(t, y):
    # система дифференциальных уравнений для скорости и высоты
    x, h, vx, vy = y
    v = math.hypot(vx, vy)

    m_t = mass(t)
    Ft = thrust(t)
    p = atmospheric_density(h)
    drag = 0.5 * Cd * p * S * v**2
    a=angle(h)

    Fxd = -drag*math.cos(a)
    Fyd = -drag*math.sin(a)

    Fxt = Ft * math.cos(a)
    Fyt = Ft * math.sin(a)

    # ускорение ракеты
    ax = (Fxt + Fxd) / m_t
    ay = (Fyt + Fyd - m_t * g) / m_t

    return [vx, vy, ax, ay]


# решение
t_end = t2
t_eval = np.linspace(0, t_end, 1200)

solution = solve_ivp(
    equations,
    (0, t_end),
    [0, 0, 0, 0], 
    t_eval=t_eval,
    rtol=1e-6,
    atol=1e-8
)

times = solution.t
x = solution.y[0]
heights = solution.y[1]
vx = solution.y[2]
vy = solution.y[3]
velocities = np.hypot(vx, vy)
masses = np.array([mass(t) for t in times])


def state_at_time(t_target):
    idx = np.argmin(np.abs(times - t_target))
    return times[idx], velocities[idx], heights[idx], masses[idx]

print("Отделение 1-й ступени:", state_at_time(t1))

# построение графиков
plt.style.use('seaborn-v0_8-darkgrid')
fig, axes = plt.subplots(3, 1, figsize=(12, 10), sharex=True)

model_color = '#1f77b4'
sim_color = '#ff7f0e'

# график скорости
axes[0].plot(times, velocities, color=model_color, lw=2.5, label='модель')
axes[0].plot(t_ksp, v_ksp, '--', color=sim_color, lw=2, label='симуляция')
axes[0].set_ylabel('скорость (м/с)')
axes[0].legend()

# график высоты
axes[1].plot(times, heights, color=model_color, lw=2.5, label='модель')
axes[1].plot(t_ksp, h_ksp, '--', color=sim_color, lw=2, label='симуляция')
axes[1].set_ylabel('высота (м)')
axes[1].legend()


# график массы
axes[2].plot(times, masses, color=model_color, lw=2.5, label='модель')
axes[2].plot(t_ksp, m_ksp, '--', color=sim_color, lw=2, label='симуляция')
axes[2].set_ylabel('масса (кг)')
axes[2].set_xlabel('время (с)')
axes[2].legend()

plt.suptitle('сравнение модели и симуляции')
plt.tight_layout()
plt.show()
